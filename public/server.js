!function(e){var n={};function t(s){if(n[s])return n[s].exports;var o=n[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=n,t.d=function(e,n,s){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:s})},t.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t.w={},t(t.s="./src/server/index.js")}({"./src/server/constants.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.CODE={ERROR:"ERROR",EMAIL_EXISTED:"EMAIL_EXISTED",EMAIL_NOT_FOUND:"EMAIL_NOT_FOUND",INVALID:"INVALID",WRONG_CREDENTIAL:"WRONG_CREDENTIAL",DONE:"DONE",NOT_LOGIN:"NOT_LOGIN",NOT_ACTIVE:"NOT_ACTIVE"}},"./src/server/db.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.saveCourse=n.getCourses=n.getCourse=n.getLink=n.addUserLink=n.saveUser=n.findUser=n.addUser=n.tables=void 0;var s,o=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e},r=t("./src/server/util.js"),i=t("mongodb"),c=(s=i)&&s.__esModule?s:{default:s};var u=c.default.ObjectID,a=c.default.MongoClient,l="mongodb://llk:llk2017@localhost:27017/llk?authMechanism=DEFAULT";function d(e){var n=void 0;return new Promise(function(e,n){a.connect(l,function(t,s){t&&n(t),e(s)})}).then(function(t){return n=t,e.bind(null,n.db("llk"))()}).then(function(e){return n.close(),e}).catch(function(e){throw n.close(),e})}var f=n.tables={users:"users",courses:"courses",user_links:"user_links"};d(function(e){return Promise.all([e.createCollection(f.users),e.createCollection(f.courses),e.createCollection(f.user_links)])});n.addUser=function(e,n){return d(function(t){return t.collection(f.users).insertOne({email:e,password:n,active:!1,registerDate:(new Date).toISOString()})})},n.findUser=function(e){return d(function(n){return console.log("db find user",e),n.collection(f.users).findOne({email:e})})},n.saveUser=function(e,n){return d(function(t){return new Promise(function(s,o){t.collection(f.users).updateOne(e,{$set:n},function(e,n){e&&o(e),s(n)})})})},n.addUserLink=function(e,n,t){return d(function(s){var i=(0,r.getRandomCode)(e);console.log("code",i);var c=o({email:e,code:i,type:n},t,{date:(new Date).toISOString()});return s.collection(f.user_links).insertOne(c).then(function(){return i})})},n.getLink=function(e){return d(function(n){return n.collection(f.user_links).findOne({code:e})})},n.getCourse=function(e,n){return d(function(t){return console.log("db get course",e,n),t.collection(f.courses).findOne({_id:new u(e),email:n})})},n.getCourses=function(e){return d(function(n){return console.log("db getcourse"),new Promise(function(t,s){n.collection(f.courses).find({email:e}).toArray(function(e,n){console.log("db getcourse res",n),e&&s(e),t(n)})})})},n.saveCourse=function(e,n,t,s){return d(function(o){return console.log("db saveCourse",e),new Promise(function(r,i){var c=e?{_id:new u(e),email:n}:{email:n,courseName:t},a={$set:{email:n,courseName:t,words:s}};o.collection(f.courses).updateOne(c,a,{upsert:!0,w:1},function(e,n){e&&(console.error(e),i(e)),r(n)})})})}},"./src/server/email.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.sendMail=function(e,n,t,s){var o=Object.assign({},i,{to:e,subject:n,html:t});r.sendMail(o,s)};var s,o=t("nodemailer");var r=((s=o)&&s.__esModule?s:{default:s}).default.createTransport({host:"smtp.163.com",port:465,secure:!0,auth:{user:"piscium2010@163.com",pass:"Gbu2017"}}),i={from:"piscium2010@163.com",to:"piscium2010@163.com",subject:"Sending Email using Node.js",html:"<h1>Welcome</h1><p>That was easy!</p>"}},"./src/server/index.js":function(e,n,t){"use strict";var s=r(t("http")),o=r(t("./src/server/server.js"));function r(e){return e&&e.__esModule?e:{default:e}}var i=s.default.createServer(o.default);o.default;i.listen(3e3)},"./src/server/server.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var s,o=t("./src/server/constants.js"),r=t("./src/server/db.js"),i=(t("./src/server/util.js"),t("./src/server/email.js")),c=t("./src/server/templates.js"),u=(s=c)&&s.__esModule?s:{default:s};t("path"),t("fs");var a=t("express")(),l=t("body-parser"),d=t("express-session");a.use(function(e,n,t){n.header("Access-Control-Allow-Origin","http://localhost:8080"),n.header("Access-Control-Allow-Credentials","true"),n.header("Access-Control-Allow-Methods","POST, GET, PUT, DELETE, OPTIONS"),n.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),n.header("Content-Type","text/plain"),t()}),a.use(d({secret:"keyboard cat",resave:!1,saveUninitialized:!0,expires:new Date(Date.now()+1728e6)})),a.use(l.urlencoded({extended:!1})),a.use(l.json());var f="http://localhost:3000/llk";a.get("/llk/",function(e,n){console.log("session",e.session),n.send("hello srts")}),a.get("/llk/links",function(e,n){console.log("links",e.query);var t=e.query.code,s="";(0,r.getLink)(t).then(function(e){var n=e.email,t=e.type,o=e.password;if(n)switch(console.log("result.type",t),t){case"activate":return s="your account has been activated",(0,r.saveUser)({email:n},{active:!0});case"reset":return s="your password has been reset",(0,r.saveUser)({email:n},{password:o});default:return Promise.reject()}}).then(function(){n.header("Content-Type","text/html"),n.send(u.default.notification.replace("{$content}","<p>"+s+"</p>"))}).catch(function(e){console.log("err",e),n.send(o.CODE.ERROR)})}),a.get("/llk/course",function(e,n){var t=e.session.uid,s=e.query.courseId;(0,r.getCourse)(s,t).then(function(e){console.log("server course",e),n.send(JSON.stringify(e||{}))})}),a.get("/llk/courses",function(e,n){var t=e.session.uid;console.log("server courses session",e.session),(0,r.getCourses)(t).then(function(e){e&&e.length?n.send(JSON.stringify(e.map(function(e){return{name:e.courseName,id:e._id}}))):n.send(JSON.stringify([{name:"examples",id:"example"}]))})}),a.put("/llk/addcourse",function(e,n){e.body.courseName;n.send("add cd")}),a.post("/llk/saveCourse",function(e,n){var t=e.body,s=t.courseId,i=t.courseName,c=t.words,u=e.session.uid;console.log("server save course",u,s,i,c),u?(0,r.saveCourse)(s,u,i,c).then(function(){n.send(o.CODE.DONE)}).catch(function(e){console.error(e),n.send(o.CODE.ERROR)}):n.send(o.CODE.NOT_LOGIN)}),a.post("/llk/login",function(e,n){var t=e.body,s=t.email,i=t.password;(0,r.findUser)(s).then(function(t){if(t)if(t.active){if(i.trim()!==t.password.trim())return console.log("",i.trim(),t.password.trim()),void n.send(o.CODE.WRONG_CREDENTIAL);e.session.uid=s,console.log("login session",e.session),n.send(o.CODE.DONE)}else n.send(o.CODE.NOT_ACTIVE);else n.send(o.CODE.WRONG_CREDENTIAL)})}),a.post("/llk/logout",function(e,n){e.session.uid="",n.send(o.CODE.DONE)}),a.post("/llk/addcourse",function(e,n){console.log("param",e.body),n.send("add")}),a.post("/llk/register",function(e,n){var t=e.body,s=t.email,c=t.password;(0,r.findUser)(s).then(function(e){e?e.active?n.send(o.CODE.EMAIL_EXISTED):n.send(o.CODE.NOT_ACTIVE):(0,r.addUser)(s,c).then(function(){return(0,r.addUserLink)(s,"activate")}).then(function(e){return new Promise(function(n,t){var o="<p>Please click below link to activate your account</p><p><a href='"+f+"/links?code="+e+"'>Activate account</a></p>";(0,i.sendMail)(s,"Please activate your account",u.default.notification.replace("{$content}",o),function(e,s){e&&t(e),n()})})}).then(function(){n.send(o.CODE.DONE)}).catch(function(e){console.log("err",e),n.send(o.CODE.ERROR)})})}),a.post("/llk/reset",function(e,n){var t=e.body,s=t.email,c=t.password;(0,r.findUser)(s).then(function(e){e?(0,r.addUserLink)(s,"reset",{password:c}).then(function(e){var n="<p>Please click below link to reset your password</p><p><a href='"+f+"/links?code="+e+"'>Confirm reset</a></p>";(0,i.sendMail)(s,"Please confirm reset password",u.default.notification.replace("{$content}",n),function(e,n){e&&reject(e),resolve()})}).then(function(){n.send(o.CODE.DONE)}):n.send(o.CODE.EMAIL_NOT_FOUND)})}),n.default=a},"./src/server/templates.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.default={notification:'\n<html>\n<head>\n    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />\n    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;">\n    <title>Message</title>\n    <style type="text/css">\n        body {\n            height:600px;\n            background: #2a2a2a;\n            font-family: \'proxima_nova_rgregular\', Helvetica\n        }\n\n        .container {\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n        }\n\n        .notification {\n            margin: 20vh auto auto;\n            padding: 30px;\n            width: 300px;\n            height: 300px;\n            background: orange;\n            border-radius: 15px;\n            color: #fff;\n            font-size: 15px;\n        }\n\n        p {\n            font-size: 15px;\n        }\n    </style>\n\n    <body>\n        <div class=\'container\'>\n            <div class=\'notification\'>{$content}</div>\n        </div>\n    </body>\n\n</html>'}},"./src/server/util.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.getRandomCode=function(e){var n=new Date,t=""+e+n.toISOString();return(0,s.createHash)("md5").update(t).digest("hex")};var s=t("crypto")},"body-parser":function(e,n){e.exports=require("body-parser")},crypto:function(e,n){e.exports=require("crypto")},express:function(e,n){e.exports=require("express")},"express-session":function(e,n){e.exports=require("express-session")},fs:function(e,n){e.exports=require("fs")},http:function(e,n){e.exports=require("http")},mongodb:function(e,n){e.exports=require("mongodb")},nodemailer:function(e,n){e.exports=require("nodemailer")},path:function(e,n){e.exports=require("path")}});