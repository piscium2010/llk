!function(e){var n={};function t(s){if(n[s])return n[s].exports;var r=n[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,t),r.l=!0,r.exports}t.m=e,t.c=n,t.d=function(e,n,s){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:s})},t.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t.w={},t(t.s="./src/server/index.js")}({"./src/server/config.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var s=n.host="www.piscium.site",r=(n.webPort=80,n.apiPort=3e3),o=n.site="llk/api";n.apiHost="http://"+s+":"+r+"/"+o},"./src/server/constants.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.CODE={ERROR:"ERROR",EMAIL_EXISTED:"EMAIL_EXISTED",EMAIL_NOT_FOUND:"EMAIL_NOT_FOUND",INVALID:"INVALID",WRONG_CREDENTIAL:"WRONG_CREDENTIAL",DONE:"DONE",NOT_LOGIN:"NOT_LOGIN",NOT_ACTIVE:"NOT_ACTIVE"}},"./src/server/db.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.saveCourse=n.getCourses=n.getCourse=n.getLink=n.addUserLink=n.saveUser=n.findUser=n.addUser=n.tables=void 0;var s,r=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e},o=t("./src/server/util.js"),i=t("mongodb"),c=(s=i)&&s.__esModule?s:{default:s},u=t("./src/server/config.js");var a=c.default.ObjectID,l=c.default.MongoClient,d="mongodb://llk:llk2017@"+u.host+":27017/llk?authMechanism=DEFAULT";function f(e){var n=void 0;return new Promise(function(e,n){l.connect(d,function(t,s){t&&n(t),e(s)})}).then(function(t){return n=t,e.bind(null,n.db("llk"))()}).then(function(e){return n.close(),e}).catch(function(e){throw n.close(),e})}var p=n.tables={users:"users",courses:"courses",user_links:"user_links"};f(function(e){return Promise.all([e.createCollection(p.users),e.createCollection(p.courses),e.createCollection(p.user_links)])});n.addUser=function(e,n){return f(function(t){return t.collection(p.users).insertOne({email:e,password:n,active:!1,registerDate:(new Date).toISOString()})})},n.findUser=function(e){return f(function(n){return console.log("db find user",e),n.collection(p.users).findOne({email:e})})},n.saveUser=function(e,n){return f(function(t){return new Promise(function(s,r){t.collection(p.users).updateOne(e,{$set:n},function(e,n){e&&r(e),s(n)})})})},n.addUserLink=function(e,n,t){return f(function(s){var i=(0,o.getRandomCode)(e);console.log("code",i);var c=r({email:e,code:i,type:n},t,{date:(new Date).toISOString()});return s.collection(p.user_links).insertOne(c).then(function(){return i})})},n.getLink=function(e){return f(function(n){return n.collection(p.user_links).findOne({code:e})})},n.getCourse=function(e,n){return f(function(t){return console.log("db get course",e,n),t.collection(p.courses).findOne({_id:new a(e),email:n})})},n.getCourses=function(e){return f(function(n){return console.log("db getcourse"),new Promise(function(t,s){n.collection(p.courses).find({email:e}).toArray(function(e,n){console.log("db getcourse res",n),e&&s(e),t(n)})})})},n.saveCourse=function(e,n,t,s){return f(function(r){return console.log("db saveCourse",e),new Promise(function(o,i){var c=e?{_id:new a(e),email:n}:{email:n,courseName:t},u={$set:{email:n,courseName:t,words:s}};r.collection(p.courses).updateOne(c,u,{upsert:!0,w:1},function(e,n){e&&(console.error(e),i(e)),o(n)})})})}},"./src/server/email.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.sendMail=function(e,n,t,s){var r=Object.assign({},i,{to:e,subject:n,html:t});o.sendMail(r,s)};var s,r=t("nodemailer");var o=((s=r)&&s.__esModule?s:{default:s}).default.createTransport({host:"smtp.163.com",port:465,secure:!0,auth:{user:"piscium2010@163.com",pass:"Gbu2017"}}),i={from:"piscium2010@163.com",to:"piscium2010@163.com",subject:"Sending Email using Node.js",html:"<h1>Welcome</h1><p>That was easy!</p>"}},"./src/server/index.js":function(e,n,t){"use strict";var s=i(t("http")),r=i(t("./src/server/server.js")),o=t("./src/server/config.js");function i(e){return e&&e.__esModule?e:{default:e}}var c=s.default.createServer(r.default);r.default;c.listen(o.apiPort,"0.0.0.0")},"./src/server/server.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var s,r=t("./src/server/constants.js"),o=t("./src/server/db.js"),i=(t("./src/server/util.js"),t("./src/server/email.js")),c=t("./src/server/templates.js"),u=(s=c)&&s.__esModule?s:{default:s},a=t("./src/server/config.js");t("path"),t("fs");var l=t("express")(),d=t("body-parser"),f=t("express-session");l.use(function(e,n,t){n.header("Access-Control-Allow-Origin","http://"+a.host),n.header("Access-Control-Allow-Credentials","true"),n.header("Access-Control-Allow-Methods","POST, GET, PUT, DELETE, OPTIONS"),n.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),n.header("Content-Type","text/plain"),t()}),l.use(f({secret:"keyboard cat",resave:!1,saveUninitialized:!0,expires:new Date(Date.now()+1728e6)})),l.use(d.urlencoded({extended:!1})),l.use(d.json()),l.get("/"+a.site+"/",function(e,n){console.log("session",e.session),n.send("hello srts")}),l.get("/"+a.site+"/links",function(e,n){console.log("links",e.query);var t=e.query.code,s="";(0,o.getLink)(t).then(function(e){var n=e.email,t=e.type,r=e.password;if(n)switch(console.log("result.type",t),t){case"activate":return s="your account has been activated",(0,o.saveUser)({email:n},{active:!0});case"reset":return s="your password has been reset",(0,o.saveUser)({email:n},{password:r});default:return Promise.reject()}}).then(function(){n.header("Content-Type","text/html"),n.send(u.default.notification.replace("{$content}","<p>"+s+"</p>"))}).catch(function(e){console.log("err",e),n.send(r.CODE.ERROR)})}),l.get("/"+a.site+"/course",function(e,n){var t=e.session.uid,s=e.query.courseId;(0,o.getCourse)(s,t).then(function(e){console.log("server course",e),n.send(JSON.stringify(e||{}))})}),l.get("/"+a.site+"/courses",function(e,n){var t=e.session.uid;console.log("server courses session",e.session),(0,o.getCourses)(t).then(function(e){e&&e.length?n.send(JSON.stringify(e.map(function(e){return{name:e.courseName,id:e._id}}))):n.send(JSON.stringify([{name:"examples",id:"example"}]))})}),l.put("/"+a.site+"/addcourse",function(e,n){e.body.courseName;n.send("add cd")}),l.post("/"+a.site+"/saveCourse",function(e,n){var t=e.body,s=t.courseId,i=t.courseName,c=t.words,u=e.session.uid;console.log("server save course",u,s,i,c),u?(0,o.saveCourse)(s,u,i,c).then(function(){n.send(r.CODE.DONE)}).catch(function(e){console.error(e),n.send(r.CODE.ERROR)}):n.send(r.CODE.NOT_LOGIN)}),l.post("/"+a.site+"/login",function(e,n){var t=e.body,s=t.email,i=t.password;(0,o.findUser)(s).then(function(t){if(t)if(t.active){if(i.trim()!==t.password.trim())return console.log("",i.trim(),t.password.trim()),void n.send(r.CODE.WRONG_CREDENTIAL);e.session.uid=s,console.log("login session",e.session),n.send(r.CODE.DONE)}else n.send(r.CODE.NOT_ACTIVE);else n.send(r.CODE.WRONG_CREDENTIAL)})}),l.post("/"+a.site+"/logout",function(e,n){e.session.uid="",n.send(r.CODE.DONE)}),l.post("/"+a.site+"/addcourse",function(e,n){console.log("param",e.body),n.send("add")}),l.post("/"+a.site+"/register",function(e,n){var t=e.body,s=t.email,c=t.password;(0,o.findUser)(s).then(function(e){e?e.active?n.send(r.CODE.EMAIL_EXISTED):n.send(r.CODE.NOT_ACTIVE):(0,o.addUser)(s,c).then(function(){return(0,o.addUserLink)(s,"activate")}).then(function(e){return new Promise(function(n,t){var r="<p>Please click below link to activate your account</p><p><a href='"+a.apiHost+"/links?code="+e+"'>Activate account</a></p>";(0,i.sendMail)(s,"Please activate your account",u.default.notification.replace("{$content}",r),function(e,s){e&&t(e),n()})})}).then(function(){n.send(r.CODE.DONE)}).catch(function(e){console.log("err",e),n.send(r.CODE.ERROR)})})}),l.post("/"+a.site+"/reset",function(e,n){var t=e.body,s=t.email,c=t.password;(0,o.findUser)(s).then(function(e){e?(0,o.addUserLink)(s,"reset",{password:c}).then(function(e){var n="<p>Please click below link to reset your password</p><p><a href='"+a.apiHost+"/links?code="+e+"'>Confirm reset</a></p>";(0,i.sendMail)(s,"Please confirm reset password",u.default.notification.replace("{$content}",n),function(e,n){e&&reject(e),resolve()})}).then(function(){n.send(r.CODE.DONE)}):n.send(r.CODE.EMAIL_NOT_FOUND)})}),n.default=l},"./src/server/templates.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.default={notification:'\n<html>\n<head>\n    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />\n    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;">\n    <title>Message</title>\n    <style type="text/css">\n        body {\n            height:600px;\n            background: #2a2a2a;\n            font-family: \'proxima_nova_rgregular\', Helvetica\n        }\n\n        .container {\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n        }\n\n        .notification {\n            margin: 20vh auto auto;\n            padding: 30px;\n            width: 300px;\n            height: 300px;\n            background: orange;\n            border-radius: 15px;\n            color: #fff;\n            font-size: 15px;\n        }\n\n        p {\n            font-size: 15px;\n        }\n    </style>\n\n    <body>\n        <div class=\'container\'>\n            <div class=\'notification\'>{$content}</div>\n        </div>\n    </body>\n\n</html>'}},"./src/server/util.js":function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.getRandomCode=function(e){var n=new Date,t=""+e+n.toISOString();return(0,s.createHash)("md5").update(t).digest("hex")};var s=t("crypto")},"body-parser":function(e,n){e.exports=require("body-parser")},crypto:function(e,n){e.exports=require("crypto")},express:function(e,n){e.exports=require("express")},"express-session":function(e,n){e.exports=require("express-session")},fs:function(e,n){e.exports=require("fs")},http:function(e,n){e.exports=require("http")},mongodb:function(e,n){e.exports=require("mongodb")},nodemailer:function(e,n){e.exports=require("nodemailer")},path:function(e,n){e.exports=require("path")}});